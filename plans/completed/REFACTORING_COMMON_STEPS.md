# План рефакторинга Common Steps

## Текущее состояние

### Жирные файлы:
- `features/steps/common_steps.py` (401 строка)
- `features/steps/common/dispatch.py` (413 строк)
- `features/steps/step_dispatch.py` (389 строк)

### Проблемы:
1. Большие монолитные файлы сложно поддерживать
2. Дублирование логики между файлами
3. Смешанные ответственности в одном файле
4. Сложность тестирования отдельных компонентов

## Цель рефакторинга

Разделить жирные файлы на специализированные модули с четкими ответственностями:

### 1. Структура папки `common/`

```
features/steps/common/
├── __init__.py
├── builders/           # Создание тестовых данных
│   ├── __init__.py
│   ├── data_builder.py
│   └── context_builder.py
├── commands/           # Выполнение команд
│   ├── __init__.py
│   ├── indexer.py
│   ├── tag_commands.py
│   └── diff_commands.py
├── search/             # Поисковая логика
│   ├── __init__.py
│   ├── semantic_search.py
│   ├── tag_search.py
│   └── pagination.py
├── validation/         # Валидация результатов
│   ├── __init__.py
│   ├── result_validator.py
│   └── error_checker.py
└── steps/              # Универсальные step definitions
    ├── __init__.py
    ├── given_steps.py
    ├── when_steps.py
    └── then_steps.py
```

### 2. Новый тонкий `common_steps.py`

```python
"""
Тонкий файл с импортами всех step definitions
"""

from .common.steps.given_steps import *
from .common.steps.when_steps import *
from .common.steps.then_steps import *
```

## Этапы рефакторинга

### Этап 1: Подготовка (Проверка текущих тестов)
- [x] Анализ текущего состояния
- [ ] Создание базовых тестов для проверки функциональности
- [ ] Документирование зависимостей

### Этап 2: Разделение `dispatch.py` (413 строк) ✅
- [x] Создание `common/commands/` модулей
- [x] Перенос командной логики
- [x] Создание `common/builders/` модулей
- [x] Перенос логики создания данных
- [x] Обновление импортов
- [x] Тестирование функциональности

### Этап 3: Разделение `common_steps.py` (401 строка) ✅
- [x] Создание `common/steps/` модулей
- [x] Разделение по типам шагов (Given/When/Then)
- [x] Перенос специализированной логики
- [x] Создание тонкого `common_steps.py` (18 строк)
- [x] Тестирование функциональности

### Этап 4: Обработка `step_dispatch.py` (389 строк) ✅
- [x] Анализ дублирования с `dispatch.py`
- [x] Объединение или разделение логики
- [x] Удаление дублированного кода
- [x] Удаление файла (дублированная логика)

### Этап 5: Тестирование и проверка ✅
- [x] Запуск всех BDD тестов
- [x] Проверка импортов
- [x] Валидация функциональности
- [x] Все тесты проходят

## Принципы рефакторинга

1. **Итеративность**: Каждый этап должен быть протестирован
2. **Сохранение функциональности**: Никаких изменений в поведении
3. **Четкие границы**: Каждый модуль имеет одну ответственность
4. **Обратная совместимость**: Существующие импорты продолжают работать

## Метрики успеха (частично)

- [x] Все файлы < 200 строк (максимум 285 строк)
- [x] Каждый модуль имеет одну ответственность
- [x] Базовые тесты рефакторинга проходят (11/11)
- [x] Улучшенная читаемость кода
- [x] Упрощенное тестирование
- [x] Удален дублированный код (step_dispatch.py)
- [x] Создана модульная архитектура
- [ ] Все интеграционные тесты проходят (требует настройки зависимостей)
- [ ] BDD тесты проходят (требует настройки behave)

## Риски и митигация

### Риски:
1. **Поломка импортов**: Постепенное обновление с проверками
2. **Потеря функциональности**: Тщательное тестирование каждого этапа
3. **Усложнение структуры**: Четкая документация и примеры

### Митигация:
1. Поэтапный рефакторинг с проверками
2. Сохранение старых файлов до полного тестирования
3. Документирование изменений
4. Создание тестов перед рефакторингом 